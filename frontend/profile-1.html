<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkillSwap Profile Setup</title>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Tagify CSS -->
  <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet">
  <style>
    /* (kept your styles, slightly added list & add button CSS) */
    :root {
      --primary-color: #6c5ce7;
      --secondary-color: #a29bfe;
      --accent-color: #fd79a8;
      --dark-color: #2d3436;
      --light-color: #f5f6fa;
      --error-color: #d63031;
      --success-color: #00b894;
      --icon-color: #6c5ce7;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f6fa 20%, #e2c3d9 90%);
      margin: 0; padding: 20px; min-height: 100vh; color: var(--dark-color);
      font-size: 18px; line-height: 1.6;
    }
    .container { max-width:700px; margin:30px auto; background:white; padding:30px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); position:relative; overflow:hidden;}
    .container::before { content:''; position:absolute; top:0; left:0; width:8px; height:100%; background:linear-gradient(to bottom,var(--primary-color),var(--accent-color)); }
    h2 { margin-bottom:20px; color:var(--primary-color); font-size:28px; display:flex; align-items:center; gap:12px; font-weight:600; }
    .form-step { display:none; animation:fadeIn .5s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    .form-step.active { display:block; }
    label { display:block; margin-bottom:12px; font-weight:500; font-size:18px; color:var(--dark-color); }
    .input-container { position:relative; max-width:100%; width:100%; margin:0 auto 20px auto; }
    input, select, textarea { width:100%; padding:15px 15px 15px 50px; font-size:18px; border:2px solid #dfe6e9; border-radius:8px; background:#f9fbfd; transition:all .3s; color:var(--dark-color); }
    .tagify { padding-left:15px !important; font-size:16px; }
    .tagify__input { padding-left:0 !important; font-size:16px; }
    select, textarea { padding-left:15px !important; }
    textarea { min-height:100px; font-size:16px; }
    input:focus, textarea:focus, select:focus { border-color:var(--primary-color); outline:none; box-shadow:0 0 0 3px rgba(108,92,231,.2); }
    .error { color:var(--error-color); font-size:16px; margin:-15px 0 20px 5px; display:none; }
    input.invalid, select.invalid, textarea.invalid { border-color:var(--error-color); }
    .button-group { display:flex; justify-content:space-between; margin-top:30px; }
    button { padding:15px 25px; font-size:18px; border:none; background-color:var(--primary-color); color:white; border-radius:8px; cursor:pointer; transition:all .3s; display:flex; align-items:center; gap:10px; font-weight:500;}
    button:hover { background-color:#5649c0; transform:translateY(-2px); box-shadow:0 5px 15px rgba(108,92,231,0.3); }
    .input-icon { position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--icon-color); font-size:20px; pointer-events:none; z-index:1; }
    .tagify-container .input-icon { left:10px; }
    .preview-img { width:120px; height:120px; border-radius:50%; object-fit:cover; margin:15px auto; display:none; border:3px solid var(--primary-color); box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    .days-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin:15px auto 20px auto; max-width:100%; }
    .days-grid label { display:flex; align-items:center; font-weight:normal; margin:0; cursor:pointer; font-size:16px; }
    .days-grid input { width:20px; height:20px; margin:0 10px 0 0; display:inline-block; }
    .time-inputs { display:flex; align-items:center; justify-content:center; gap:20px; max-width:100%; margin:15px auto 20px auto; }
    .time-inputs .input-container { margin:0; flex:1; }
    .time-inputs span { color:#666; font-size:18px; }
    .star-rating { display:flex; justify-content:center; margin:15px auto 20px auto; gap:10px; }
    .star-rating span { font-size:30px; color:#ddd; cursor:pointer; transition:color .2s; }
    .star-rating span:hover, .star-rating span.active { color:#ffc107; }
    .progress-bar { height:8px; background:#e0e0e0; border-radius:4px; margin-bottom:30px; overflow:hidden; }
    .progress { height:100%; background:linear-gradient(to right,var(--primary-color),var(--accent-color)); width:20%; transition:width .3s; }
    .file-upload { display:flex; flex-direction:column; align-items:center; margin:20px auto; }
    .file-upload-label { display:inline-flex; align-items:center; gap:10px; padding:15px 30px; background:var(--light-color); color:var(--primary-color); border-radius:8px; cursor:pointer; font-size:18px; transition:all .3s; border:2px dashed var(--primary-color); }
    .file-upload-label:hover { background:#e9e3ff; transform:translateY(-2px); box-shadow:0 5px 15px rgba(108,92,231,0.1); }
    .success-message { display:none; background-color:var(--success-color); color:white; padding:20px; border-radius:8px; margin-bottom:20px; text-align:center; font-size:18px; }
    /* skill list + add button */
    .skills-row { display:flex; gap:10px; align-items:center; }
    .skills-row .input-container { flex:1; margin:0; }
    .skills-list { list-style:none; padding:0; display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .skills-list li { background:#f1f3f5; padding:8px 10px; border-radius:8px; display:flex; gap:8px; align-items:center; }
    .skills-list button.remove { background:none; border:none; cursor:pointer; color:#c82333; font-size:16px; padding:0; }
    .btn-add { padding:10px 14px; border-radius:6px; border:none; background:#6f42c1; color:white; cursor:pointer; }
    .checkbox-group label { margin-right:12px; }
    @media (max-width:768px) {
      body { padding:10px; font-size:16px; }
      .container { padding:20px; margin:15px auto; }
      h2 { font-size:24px; }
      .days-grid { grid-template-columns:repeat(3,1fr); }
      button { padding:12px 20px; font-size:16px; }
    }
    @media (max-width:480px) {
      .container { padding:15px; }
      h2 { font-size:22px; }
      input, select, textarea { padding:12px 12px 12px 40px; font-size:16px; }
      .days-grid { grid-template-columns:repeat(2,1fr); }
      .time-inputs { flex-direction:column; gap:10px; }
      .time-inputs span { margin:5px 0; }
      button { width:48%; }
      .skills-row { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="progress-bar"><div class="progress" id="progressBar"></div></div>

  <form id="multiStepForm" novalidate>
    <!-- Step 1 -->
    <div class="form-step active">
      <h2><i class="fas fa-user-edit"></i> Basic Information</h2>
      <label>Full Name:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-user"></i></span><input type="text" name="name" required></div>
      <div class="error">Full name is required</div>

      <label>Username:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-at"></i></span><input type="text" name="username" required></div>
      <div class="error">Username is required</div>

      <label>Email:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-envelope"></i></span><input type="email" name="email" required></div>
      <div class="error">Valid email is required</div>

      <label>Phone Number:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-phone"></i></span><input type="tel" name="phone" pattern="[0-9]{10}" required></div>
      <div class="error">Valid 10-digit phone number required</div>

      <label>Location:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-map-marker-alt"></i></span><input type="text" name="location" required></div>
      <div class="error">Location is required</div>

      <label>Bio:</label>
      <div class="input-container"><span class="input-icon"><i class="fas fa-pen"></i></span><textarea name="bio" rows="4"></textarea></div>

      <div class="button-group"><span></span><button type="button" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
    </div>

    <!-- Step 2: Skills -->
    <div class="form-step">
      <h2><i class="fas fa-lightbulb"></i> Skill Information</h2>

      <label>Skills Offered:</label>
      <div class="skills-row" style="margin-bottom:8px;">
        <div class="input-container tagify-container" style="flex:1;">
          <span class="input-icon"><i class="fas fa-hands-helping"></i></span>
          <input id="skillsOfferedInput" name="skills_offered" class="skills-input" placeholder="Type or pick a skill (e.g., Python)"/>
        </div>
        <div style="width:160px;">
          <select id="skillLevelOffered" class="skills-offered-input-level">
            <option value="">Select level</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Expert</option>
          </select>
        </div>
        <div>
          <button type="button" id="addOfferedBtn" class="btn-add"><i class="fas fa-plus"></i></button>
        </div>
      </div>
      <div class="error" id="skillsOfferedError">Please add at least one offered skill</div>

      <label>Select Skill Categories:</label>
      <div class="checkbox-group" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:8px;">
        <label><input type="checkbox" name="skill_category_offered" value="Programming"> Programming</label>
        <label><input type="checkbox" name="skill_category_offered" value="Design"> Design</label>
        <label><input type="checkbox" name="skill_category_offered" value="Music & Arts"> Music & Arts</label>
        <label><input type="checkbox" name="skill_category_offered" value="Photography"> Photography</label>
        <label><input type="checkbox" name="skill_category_offered" value="Business"> Business</label>
        <label><input type="checkbox" name="skill_category_offered" value="Culinary"> Culinary</label>
        <label><input type="checkbox" name="skill_category_offered" value="Languages"> Languages</label>
      </div>
      <div class="error" id="skillCategoriesErrorOffered">Select at least one category</div>

      <ul id="skillsOfferedList" class="skills-list" aria-live="polite"></ul>

      <hr style="margin:16px 0;" />

      <label>Skills Wanted:</label>
      <div class="skills-row" style="margin-bottom:8px;">
        <div class="input-container tagify-container" style="flex:1;">
          <span class="input-icon"><i class="fas fa-search"></i></span>
          <input id="skillsWantedInput" name="skills_wanted" class="skills-input" placeholder="Type or pick a skill you want to learn" />
        </div>
        <div style="width:160px;">
          <select id="skillLevelWanted" class="skills-wanted-input-level">
            <option value="">Select level</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Expert</option>
          </select>
        </div>
        <div>
          <button type="button" id="addWantedBtn" class="btn-add"><i class="fas fa-plus"></i></button>
        </div>
      </div>
      <div class="error" id="skillsWantedError">Please add at least one wanted skill</div>

      <label>Select Skill Categories:</label>
      <div class="checkbox-group" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:8px;">
        <label><input type="checkbox" name="skill_category_wanted" value="Programming"> Programming</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Design"> Design</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Music & Arts"> Music & Arts</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Photography"> Photography</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Business"> Business</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Culinary"> Culinary</label>
        <label><input type="checkbox" name="skill_category_wanted" value="Languages"> Languages</label>
      </div>
      <div class="error" id="skillCategoriesErrorWanted">Select at least one category</div>

      <ul id="skillsWantedList" class="skills-list" aria-live="polite"></ul>

      <div class="button-group">
        <button type="button" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Back</button>
        <button type="button" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 3: Availability -->
    <div class="form-step">
      <h2><i class="far fa-calendar-alt"></i> Availability</h2>
      <label>Preferred Days:</label>
      <div class="days-grid">
        <label><input type="checkbox" name="days" value="Mon"> Mon</label>
        <label><input type="checkbox" name="days" value="Tue"> Tue</label>
        <label><input type="checkbox" name="days" value="Wed"> Wed</label>
        <label><input type="checkbox" name="days" value="Thu"> Thu</label>
        <label><input type="checkbox" name="days" value="Fri"> Fri</label>
        <label><input type="checkbox" name="days" value="Sat"> Sat</label>
        <label><input type="checkbox" name="days" value="Sun"> Sun</label>
      </div>
      <div class="error">Select at least one day</div>

      <label>Time Slots:</label>
      <div class="time-inputs">
        <div class="input-container"><span class="input-icon"><i class="far fa-clock"></i></span><input type="time" name="start_time"></div>
        <span>to</span>
        <div class="input-container"><span class="input-icon"><i class="far fa-clock"></i></span><input type="time" name="end_time"></div>
      </div>
      <div class="error">Enter valid time range</div>

      <label>Time Zone:</label>
      <div class="input-container tagify-container">
        <span class="input-icon"><i class="fas fa-globe"></i></span>
        <select name="timezone">
          <option value="">Select</option>
          <option value="America/New_York">EST (New York)</option>
          <option value="America/Chicago">CST (Chicago)</option>
          <option value="America/Denver">MST (Denver)</option>
          <option value="America/Los_Angeles">PST (Los Angeles)</option>
          <option value="Europe/London">GMT (London)</option>
          <option value="Europe/Paris">CET (Paris)</option>
          <option value="Asia/Kolkata">IST (India)</option>
          <option value="Asia/Tokyo">JST (Tokyo)</option>
        </select>
      </div>
      <div class="error">Select your timezone</div>

      <div class="button-group">
        <button type="button" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Back</button>
        <button type="button" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 4: Social & Submit -->
    <div class="form-step">
      <h2><i class="fas fa-share-alt"></i> Social Links</h2>
      <label>LinkedIn:</label>
      <div class="input-container"><span class="input-icon"><i class="fab fa-linkedin"></i></span><input type="url" name="linkedin" placeholder="https://linkedin.com/in/username"></div>
      <label>GitHub/Portfolio:</label>
      <div class="input-container"><span class="input-icon"><i class="fab fa-github"></i></span><input type="url" name="portfolio" placeholder="https://github.com/username"></div>

      <div class="button-group">
        <button type="button" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Back</button>
        <button type="submit"><i class="fas fa-check-circle"></i> Submit</button>
      </div>
    </div>
  </form>
</div>

<!-- Tagify JS -->
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>

<script>
const steps = document.querySelectorAll(".form-step");
let currentStep = 0;
const totalSteps = steps.length;

const initTagify = () => {
  const skillsInputs = document.querySelectorAll('.skills-input');
  skillsInputs.forEach(input => {
    if (input.tagify) input.tagify.destroy();
    new Tagify(input, {
      whitelist: ["JavaScript", "Python", "Graphic Design", "UI/UX", "React", "Node.js", "Photoshop", "Writing", "Marketing", "HTML/CSS", "Java", "C++", "DSA", "SQL", "Machine Learning", "Data Science", "3D Modelling", "Motion Graphics", "Game Design", "Interior Design", "Guitar", "Piano", "Singing & Vocal", "Oil Painting", "Sketching & Drawing", "Sculpture Making", "English", "Spanish", "French", "Telugu", "Hindi", "Baking", "Food Presentation", "Italian Cuisine", "Pastry Making", "Grilling & Barbecue"],
      dropdown: { maxItems: 10, enabled: 1, closeOnSelect: false },
      originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
    });
  });
};

const updateProgress = () => {
  const progress = ((currentStep + 1) / totalSteps) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
};

function showStep(index) {
  steps.forEach((step, i) => {
    step.classList.toggle("active", i === index);
  });
  updateProgress();
}

function validateStep(step) {
  let isValid = true;
  const errors = step.querySelectorAll('.error');
  errors.forEach(err => err.style.display = "none");

  const inputs = step.querySelectorAll("input, select, textarea");
  inputs.forEach(input => {
    const error = input.closest('.input-container')?.nextElementSibling;
    input.classList.remove("invalid");
    if (error?.classList.contains('error')) error.style.display = "none";

    // Skip validation for Tagify input elements (we validate via lists)
    if (input.classList.contains('skills-input')) return;

    if (input.required && !input.value.trim()) {
      input.classList.add("invalid");
      if (error?.classList.contains('error')) error.style.display = "block";
      isValid = false;
    }

    if (input.name === "phone" && input.value && !/^\d{10}$/.test(input.value.trim())) {
      input.classList.add("invalid");
      if (error?.classList.contains('error')) error.style.display = "block";
      isValid = false;
    }

    if (input.name === "email" && input.value && !/^[a-zA-Z0-9._%+-]+@(gmail\.com|rguktong\.ac\.in)$/.test(input.value.trim())) {
      input.classList.add("invalid");
      if (error?.classList.contains('error')) {
        error.textContent = "Please enter a valid RGUKT or Gmail address";
        error.style.display = "block";
      }
      isValid = false;
    }
  });

  // Days validation
  if (step.querySelector('.days-grid')) {
    const checked = step.querySelectorAll('input[name="days"]:checked');
    if (checked.length === 0) {
      step.querySelector('.days-grid').nextElementSibling.style.display = "block";
      isValid = false;
    }
  }

  // Time range validation
  const startInput = step.querySelector('input[name="start_time"]');
  const endInput = step.querySelector('input[name="end_time"]');
  if (startInput && endInput) {
    const start = startInput.value;
    const end = endInput.value;
    if (start && end && start >= end) {
      step.querySelector('.time-inputs').nextElementSibling.style.display = "block";
      isValid = false;
    }
  }

  // Custom validation for skills step: ensure lists have items
  if (step.querySelector('#skillsOfferedList')) {
    const c = step.querySelectorAll('#skillsOfferedList li').length;
    if (c === 0) {
      document.getElementById('skillsOfferedError').style.display = 'block';
      isValid = false;
    }
  }
  if (step.querySelector('#skillsWantedList')) {
    const c2 = step.querySelectorAll('#skillsWantedList li').length;
    if (c2 === 0) {
      document.getElementById('skillsWantedError').style.display = 'block';
      isValid = false;
    }
  }

  return isValid;
}

function nextStep() {
  if (validateStep(steps[currentStep])) {
    if (currentStep < steps.length - 1) {
      currentStep++;
      showStep(currentStep);
    }
  }
}
function prevStep() {
  if (currentStep > 0) {
    currentStep--;
    showStep(currentStep);
  }
}

function previewImage(event) {
  const reader = new FileReader();
  reader.onload = function () {
    const preview = document.getElementById("preview");
    preview.src = reader.result;
    preview.style.display = "block";
  };
  if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
}

function rate(rating) {
  const stars = document.querySelectorAll('.star-rating span');
  stars.forEach((star, index) => star.classList.toggle('active', index < rating));
  document.querySelector('input[name="rating"]').value = rating;
}

/* ===== skill add / list logic (preserves Tagify) ===== */
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function createSkillListItem({ skillName, skillLevel, categoriesText }) {
  const li = document.createElement('li');
  li.innerHTML = `
    <span style="font-weight:500;">${escapeHtml(skillName)}</span>
    <span style="font-size:0.85em; color:#6c757d;">(${escapeHtml(skillLevel)})</span>
    ${categoriesText ? `<small style="font-size:0.8em; color:#495057;"> &nbsp;•&nbsp; ${escapeHtml(categoriesText)}</small>` : ''}
    <button type="button" class="remove" title="Remove"><i class="fas fa-times-circle"></i></button>
  `;
  li.setAttribute('data-skill-name', skillName);
  li.setAttribute('data-skill-level', skillLevel);
  li.setAttribute('data-skill-categories', categoriesText || '');
  // remove handler
  li.querySelector('button.remove').addEventListener('click', (e) => e.currentTarget.parentNode.remove());
  return li;
}

function addSkill(kind) {
  const lower = kind.toLowerCase();
  const inputEl = document.getElementById(lower === 'offered' ? 'skillsOfferedInput' : 'skillsWantedInput');
  const levelEl = document.getElementById(lower === 'offered' ? 'skillLevelOffered' : 'skillLevelWanted');
  const listEl = document.getElementById(kind === 'Offered' ? 'skillsOfferedList' : 'skillsWantedList');

  // Tagify instance
  const tagifyInst = inputEl.tagify;
  const tags = (tagifyInst && Array.isArray(tagifyInst.value)) ? tagifyInst.value : [];
  let skillName = tags.length ? tags[0].value.trim() : inputEl.value.trim();
  const skillLevel = levelEl.value.trim();

  // categories: different for offered and wanted
  const categoryName = lower === 'offered' ? 'skill_category_offered' : 'skill_category_wanted';
  const categories = Array.from(document.querySelectorAll(`input[name="${categoryName}"]:checked`)).map(cb => cb.value);

  // validation
  if (!skillName) { alert('Please enter or select a skill name.'); return; }
  if (!skillLevel) { alert('Please select a skill level.'); return; }
  if (categories.length === 0) {
    document.getElementById(lower === 'offered' ? 'skillCategoriesErrorOffered' : 'skillCategoriesErrorWanted').style.display = 'block';
    return;
  } else {
    document.getElementById(lower === 'offered' ? 'skillCategoriesErrorOffered' : 'skillCategoriesErrorWanted').style.display = 'none';
  }

  // create list item
  const li = createSkillListItem({ skillName, skillLevel, categoriesText: categories.join(', ') });
  li.setAttribute('data-skill-categories', JSON.stringify(categories));
  listEl.appendChild(li);

  // reset inputs
  if (tagifyInst && tagifyInst.removeAllTags) tagifyInst.removeAllTags();
  else inputEl.value = '';
  levelEl.value = '';
  document.querySelectorAll(`input[name="${categoryName}"]:checked`).forEach(cb => cb.checked = false);

  // hide errors
  if (kind === 'Offered') document.getElementById('skillsOfferedError').style.display = 'none';
  else document.getElementById('skillsWantedError').style.display = 'none';
}



/* Populate function (used when fetching profile) */
function populateSkillsList(targetListId, skillsArray) {
  const container = document.getElementById(targetListId);
  if (!container || !Array.isArray(skillsArray)) return;
  skillsArray.forEach(s => {
    // handle different shapes from server
    const skillName = s.skillName || s.name || '';
    const skillLevel = s.level || s.skillLevel || '';
    let categoriesText = '';
    if (s.category) {
      if (Array.isArray(s.category)) categoriesText = s.category.join(', ');
      else categoriesText = String(s.category);
    } else if (s.categories) {
      categoriesText = Array.isArray(s.categories) ? s.categories.join(', ') : String(s.categories || '');
    }
    const li = createSkillListItem({ skillName, skillLevel, categoriesText });
    container.appendChild(li);
  });
}

/*backend integration (fetch & submit) */
const getToken = () => localStorage.getItem('token');

async function fetchAndPopulateProfile() {
  const token = getToken();
  if (!token) return; // silently return if not logged in
  try {
    const response = await fetch('http://localhost:5000/api/profile', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json', 'x-auth-token': token }
    });
    const user = await response.json();
    if (response.ok) {
      // populate simple fields if exist
      if (user.profile) {
        document.querySelector('input[name="name"]') && (document.querySelector('input[name="name"]').value = user.profile.fullName || '');
        document.querySelector('input[name="username"]') && (document.querySelector('input[name="username"]').value = user.profile.username || '');
        document.querySelector('input[name="location"]') && (document.querySelector('input[name="location"]').value = user.profile.location || '');
        document.querySelector('textarea[name="bio"]') && (document.querySelector('textarea[name="bio"]').value = user.profile.bio || '');
      }
      user.email && document.querySelector('input[name="email"]') && (document.querySelector('input[name="email"]').value = user.email);
      user.phoneNumber && document.querySelector('input[name="phone"]') && (document.querySelector('input[name="phone"]').value = user.phoneNumber);

      // populate skills
      if (Array.isArray(user.profile?.skillsOffered) && user.profile.skillsOffered.length) {
        populateSkillsList('skillsOfferedList', user.profile.skillsOffered);
      } else if (Array.isArray(user.skillsOffered) && user.skillsOffered.length) {
        populateSkillsList('skillsOfferedList', user.skillsOffered);
      }
      if (Array.isArray(user.profile?.skillsToLearn) && user.profile.skillsToLearn.length) {
        populateSkillsList('skillsWantedList', user.profile.skillsToLearn);
      } else if (Array.isArray(user.skillsToLearn) && user.skillsToLearn.length) {
        populateSkillsList('skillsWantedList', user.skillsToLearn);
      }
    } else {
      console.error('Failed to fetch profile:', user);
    }
  } catch (err) {
    console.error('Error fetching profile:', err);
  }
}

async function submitProfile(formData) {
  const token = getToken();
  if (!token) {
    alert('Authentication failed. Please log in again.');
    window.location.href = 'newindex.html';
    return;
  }
  try {
    const response = await fetch('http://localhost:5000/api/profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
      body: JSON.stringify(formData)
    });
    const result = await response.json();
    if (response.ok) {
      alert('✅ Profile saved successfully!');
      console.log('Saved:', result);
      window.location.href = 'homepage.html';
    } else {
      alert(result.msg || 'Failed to save profile.');
      console.error(result);
    }
  } catch (err) {
    console.error('Error submitting profile:', err);
    alert('An error occurred. Please try again.');
  }
}

/* Final submit handler*/
document.getElementById("multiStepForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  // Validate current step
  if (!validateStep(steps[currentStep])) return;

  // Build skillsOffered array
  const skillsOffered = Array.from(document.querySelectorAll('#skillsOfferedList li')).map(li => ({
  skillName: li.getAttribute('data-skill-name'),
  level: li.getAttribute('data-skill-level'),
  category: JSON.parse(li.getAttribute('data-skill-categories') || '[]')
}));

const skillsWanted = Array.from(document.querySelectorAll('#skillsWantedList li')).map(li => ({
  skillName: li.getAttribute('data-skill-name'),
  level: li.getAttribute('data-skill-level'),
  category: JSON.parse(li.getAttribute('data-skill-categories') || '[]')
}));


  // Collect other fields
  const formData = {
    fullName: document.querySelector('input[name="name"]')?.value || '',
    username: document.querySelector('input[name="username"]')?.value || '',
    phoneNumber: document.querySelector('input[name="phone"]')?.value || '',
    location: document.querySelector('input[name="location"]')?.value || '',
    bio: document.querySelector('textarea[name="bio"]')?.value || '',
    skillsOffered: skillsOffered,
    skillsToLearn: skillsWanted,
    availability: {
      days: Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value),
      time: `${document.querySelector('input[name="start_time"]')?.value || ''} - ${document.querySelector('input[name="end_time"]')?.value || ''}`,
      timezone: document.querySelector('select[name="timezone"]')?.value?.trim() || ''
    },
    socialLinks: {
      linkedin: document.querySelector('input[name="linkedin"]')?.value || '',
      github: document.querySelector('input[name="portfolio"]')?.value || ''
    }
  };


  await submitProfile(formData);
});

/* DOM Ready: init Tagify, progress, fetch profile, attach add buttons */
document.addEventListener('DOMContentLoaded', () => {
  initTagify();
  updateProgress();
  fetchAndPopulateProfile();
  showStep(currentStep);

  // Attach add button handlers
  document.getElementById('addOfferedBtn').addEventListener('click', () => addSkill('Offered'));
  document.getElementById('addWantedBtn').addEventListener('click', () => addSkill('Wanted'));
});
</script>
</body>
</html>
